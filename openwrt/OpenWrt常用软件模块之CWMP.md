## Openwrt常用软件模块之CWMP

### CWMP概述

> CWMP（CPE WAN Management Protocol）是一个面向终端设备的**网管技术规范**。这个技术规范提供了对下一代网络中家庭网络设备进行管理配置的通用框架、消息规范、管理方法和数据模型 。
>
>  它由宽带（Broadband）论坛管理和发布，于2004年发布第一版，文件编号为TR-069 

**CWMP 中定义了以下两种基本网络元素：**

- **ACS：** 自动配置服务器（Auto Configuration Server），网络中的管理服务器
- **CPE：** 客户端设备（Customer premises equipment），网络中的被管理设备

CWMP作为一个 **双向的SOAP/ HTTP的协议** ，它定义了客户端设备和自动配置服务器之间的通信协议。它包括一个安全的自动配置和其他CPE管理功能控制整体框架。协议支持了不同的互联网接入设备，如调制解调器、路由器、机顶盒和VoIP电话等。标准TR-069 协议的自动配置服务器对这些设备进行自动配置和管理 。

CWMP是一个基于文本的协议，在设备和自动配置服务器之间 **传输 HTTP文本**。在HTTP层面上CPE是客户端，ACS起到HTTP服务器的作用。这意味着控制配置数据的流动是客户端设备的职责 

- **会话的概念：** 所有的通信和操作都在配置会话的范围内进行。会话是由设备从一个通知（Inform）消息的传输开始的。ACS 服务器在收到通知消息时，开始对 CPE 调用接口方法进行状态查 询和配置。认证对于 CPE 来说是必不可少的，一般采用摘要认证算法来对 CPE 进行认证

- **配置数据模型：**

  大多数的配置和诊断是通过

  **设置和检索设备参数**

  的值来实现的。这些配置都是组织为 一个定义良好的层次结构，包括常见或不太常见的所有设备模型。宽带论坛发布的数据模型标准有两种格式：（TR181包含了大多数设备类型的数据模型定义，设备所支持的管理模型用设备节点Device.DeviceInfo.SupportedDataModel来表示）

  - XML包含每一个子元素的详细规范
  - 可读细节的PDF文件格式

- 每一个定义的对象节点都需要标识出 **是可修改的还是只读** 的。这些是通过GetParameter Names方法来获取设备支持配置对象节点报告。设备不应允许标记为只读的任何参数的修 改。TR181 数据模型的规格和扩展清楚地标识了大多数设备参数的规格。参数的类型和含 义在标准 TR181 中有详细定义

- **应用场景与优点：** CWMP主要应用于电话、有线电视、宽带等家庭接入网络环境。在这些接入网络中， 由于用户设备数量很多，并且用户分散，不容易进行设备的管理和维护。采用CWMP协议，可以实现ACS对CPE设备的远程集中管理，解决了CPE设备的管理维护问题，提高了网络的运维效率

### 方法和流程

设备的整个管理过程是建立在定义好的一组简单的操作方法上，每个方法都是**原子操作**。如果设备不能执行一个配置命令那就返回给 ACS适当的错误值。设备不应当因为错误中止会话 

| 方 法              | 含 义                                                       |
| ------------------ | ----------------------------------------------------------- |
| SetParameterValues | 服务器用来修改 CPE 的参数                                   |
| GetParameterValues | 用于服务器获取 CPE 的参数配置值。一次可以获取一个或多个参数 |
| GetParameterNames  | 用于服务器来发现客户端可以访问的配置参数                    |
| Inform             | CPE 调用服务器的 Inform 方法来建立和服务器之间的传输会话    |
| AddObject          | 用于服务器来针对多实例对象来创建新的实例                    |
| DeleteObject       | 服务器删除客户端多实例中的一个实例                          |

 为适应终端数量巨大并且地址不固定的特性，TR069 定义的交互流程中，管理交互通常都是由 CPE 发起的，由 CPE 来“请求”ACS 进行管理（见下图）。当 ACS 希望启动对 CPE 的管理时，协议定义了一个反向触发机制。CPE 建立一个用于侦听的 HTTP 端口，这 个端口地址信息在 CPE 初始连接时上报给 ACS，当 ACS 希望对 CPE 进行管理时，ACS 向 该端口建立传输控制协议连接并发送空的 POST 请求报文，CPE 收到该请求报文后随即启 动正向的 HTTP/HTTPS 连接，请求自动配置服务器的管理 。

<img src="E:\gateway_git\openwrt-database\note\hzp\pic\CWMP.png"  />

>- **第1步：** CPE和ACS建立TCP连接
> - **第2步：** SSL初始化进行双向认证
> - **第3步：** CPE发送Inform报文，开始建立 CWMP 连接。Inform 报文使用 Eventcode 字段 描述发送 Inform 报文的原因，通常为“0 BOOTSTRAP”，表示 CPE 首次启动建立连接
> - **第4步：** 如果CPE通过 ACS 的认证，ACS 将返回 Inform 响应报文，连接建立完成
> - **第5步：** 如果CPE没有别的请求，就会发送一个 HTTP Post 请求，内容为空，以满足 HTTP 报文请求/响应报文交互规则（CWMP 是基于 HTTP 协议的，CWMP 报文作为 HTTP 报文 的数据部分封装在 HTTP 报文中）
> - **第6步：** ACS 查询 CPE 上设置的轮询通知间隔的值等
> - **第7步：** CPE 把自身的轮询通知间隔的值返回给 ACS
> - **第8步：** ACS发现轮询通知间隔的值设置不符合服务器配置，于是发起设置请求，要求将CPE的轮询通知间隔的值设置为1800 秒
> - **第9步：** 设置成功后，CPE发送响应报文
> - **第10步：** ACS 发送空报文通知CPE没有别的请求了
> - **第11步：** CPE 关闭连接

#### 配置CWMP

[http://easycwmp.org/](http://easycwmp.org/)   [EasyCwmp-support](http://support.easycwmp.org/my_view_page.php)

[EasyCwmp—openwrt](https://openwrt.org/docs/techref/ucwmp)   [下载EasyCwmp](http://easycwmp.org/get/)











